name: Deploy to dev-in2
on:
  workflow_dispatch:
  push:
    branches:
      - development
      - ravi-test
    paths-ignore:
      - 'kube/values.yaml'
      - 'client/*'
      - 'scripts/*'
      - 'config/*'
      - 'proto/*'
      - '.dockerignore'
      - '.gitignore'
      - 'docker-compose.yml'
      - 'LICENSE'
      - 'README.md'
  
jobs:
  deploy:
    name: Deploy
    runs-on: self-hosted

    env:
      ENV: dev
      VAULT_PREFIX: in2
      DEPLOYMENT_NAME: sfu
      RELEASE_NAME: hmssfu0
      GCP_PROJECT_ID: dev-in2
      GCP_REGION: asia-south1
      GCP_NAMESPACE: ion2
      GCP_CLUSTER: dev-in2
      DOCKER_GIT_TOKEN: ${{ secrets.DOCKER_GIT_TOKEN }}
      
    steps:

    - name: set environment optimistically
      run: |
        echo "$(pwd)/webrtc_checkout/src/third_party/android_sdk/public/platform-tools" >> $GITHUB_PATH
        echo "$(pwd)/webrtc_checkout/src/third_party/android_sdk/public/tools/" >> $GITHUB_PATH
        echo "$(pwd)/webrtc_checkout/src/build/android" >> $GITHUB_PATH
        echo "ANDROID_SDK_ROOT=$(pwd)/webrtc_checkout/src/third_party/android_sdk/public/" >> $GITHUB_PATH
        echo "ANDROID_HOME=$(pwd)/webrtc_checkout/src/third_party/android_sdk/public/" >> $GITHUB_PATH
        echo "INITIAL_RUN_DIRECTORY=$(pwd)" >> $GITHUB_PATH
        echo $ANDROID_HOME
        echo "$INITIAL_RUN_DIRECTORY"

    - name: get depot tools
      id: get-depot-tools
      run: |
        python3 -v 
        df -kh
        echo "$(pwd)/depot_tools" >> $GITHUB_PATH

#     - name: clone 
#       id: clone
#       working-directory: ./webrtc_checkout
#       run: |
#         fetch --nohooks webrtc_android
#         ls -al
#         gclient sync --with_branch_heads --with_tags

    - name: install dependencies
      id: install dependencies
      working-directory: ./webrtc_checkout/src
      run: |
        git fetch
        git checkout refs/remotes/branch-heads/4515
        gclient sync --with_branch_heads --with_tags 
        ./build/install-build-deps.sh        

    - name: build
      id: build
      working-directory: ./webrtc_checkout/src
      run: |
        python3 ./tools_webrtc/android/build_aar.py || exit 0
        ls -alR
        ls -alR $INITIAL_RUN_DIRECTORY

    - name: Upload a Build Artifact library
      uses: actions/upload-artifact@v2.2.4
      with:
        path:
          ./webrtc_checkout/src/libwebrtc.aar

    - name: Upload a Build Artifact licence
      uses: actions/upload-artifact@v2.2.4
      with:
        path:
          ./webrtc_checkout/src/LICENCE.md

#    - uses: colpal/actions-clean@v1
#      if: ${{ always() }} 
